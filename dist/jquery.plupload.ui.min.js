/*
* pluploadUI - jQuery plugin for rendering dialog
*
* Version: 0.0.1a
* Copyright 2011 Alex Tkachev
*
* Dual licensed under MIT or GPLv2 licenses
*   http://en.wikipedia.org/wiki/MIT_License
*   http://en.wikipedia.org/wiki/GNU_General_Public_License
*
* Date: Mon Jul 18 18:33:51 2011 +0300
*/
(function(a){a.pluploadUI={},a.fn.pluploadUI=function(b){if(b=="api")return this.data("api");if(a.type(b)==="object"){var c=b.type||a.fn.pluploadUI.defaults.type,d=a.fn.pluploadUI.types[c];if(!a.isFunction(d))throw"unknown ui type "+d;b=a.extend(!0,{},a.fn.pluploadUI.defaults,d.defaults,b),b.type=d,this.each(function(){var c=a(this),e=a.extend(!0,{rtl:c.css("direction")=="rtl",container:{id:plupload.guid()},browse:{id:plupload.guid()}},b);e.uploader.container=e.container.id,e.uploader.browse_button=e.browse.id,c.data("api",new d(c,e))})}return this},a.fn.pluploadUI.types={},a.fn.pluploadUI.defaults={type:"single",browse:{text:"Choose file"},uploader:{dragdrop:!1,multi_selection:!0,multipart:!0,runtimes:"gears,silverlight,flash,html5,browserplus",max_file_size:"5mb"}}})(jQuery),function(a){a.pluploadUI.i18n=a.i18n();var b={};b[plupload.INIT_ERROR]="errors.init",b[plupload.IO_ERROR]="errors.io",b[plupload.FILE_SIZE_ERROR]="errors.fileSize",b[plupload.FILE_EXTENSION_ERROR]="errors.fileExtension",a.pluploadUI.errorCodeToI18nKey=function(a){return b[a]}}(jQuery),function($){var SingleFileUIClass=function(){this.initialize.apply(this,arguments)};$.extend(SingleFileUIClass.prototype,{initialize:function(a,b){this.options=b,this.el=this._createUI(a,b),b.rtl&&this.el.addClass("rtl"),this.uploader=new plupload.Uploader(b.uploader),this._initUploadListeners(),this.uploader.init()},_createUI:function(a,b){var c=$('<div id="'+b.container.id+'" class="pluploadUI singleFile"><div class="messages"><div class="message intro">'+$.pluploadUI.i18n.t("single.messages.intro")+'</div><div class="message uploading"><span class="icon">'+$.pluploadUI.i18n.t("single.messages.uploading")+'</span><span class="percent"/></div><div class="message error"/><div class="message success">'+$.pluploadUI.i18n.t("single.messages.success")+'</div></div><div class="choose"><div id="'+b.browse.id+'" class="button">'+$.pluploadUI.i18n.t("single.browseButton.text")+'</div><div class="info"/><div class="clear"/></div><div class="debug"><h5>debugging:</h5></div></div>');b.browse.cls&&$("div.choose div.button",c).addClass(b.browse.cls),b.container.cls&&c.addClass(b.container.cls),$("div.messages div.message",c).not(".intro").hide(),$("div.info",c).append($("div.info",a).children());return c.appendTo(a)},_initUploadListeners:function(){var uploader=this.uploader,self=this;uploader.bind("Init",function(a,b){self.debug("Current runtime: "+b.runtime),self._showMessage("intro")}),uploader.bind("FilesAdded",function(a,b){a.refresh(),setTimeout(function(){var b=!1;for(var c=0;c<a.files.length;c++)if(a.files[c].status==plupload.QUEUED){b=!0;break}b&&a.start()},300)}),uploader.bind("Error",function(a,b){var c=null;b.code==plupload.INIT_ERROR?self.el.addClass("noRuntimeAvailable"):b.code==plupload.FILE_SIZE_ERROR&&(c=$.pluploadUI.i18n.t($.pluploadUI.errorCodeToI18nKey(b.code),{size:plupload.formatSize(b.file.size),max:plupload.formatSize(a.settings.max_file_size)})),c===null&&(c=$.pluploadUI.errorCodeToI18nKey(b.code)?$.pluploadUI.i18n.t($.pluploadUI.errorCodeToI18nKey(b.code)):b.message),self._showMessage("error",c)}),uploader.bind("StateChanged",function(){uploader.state===plupload.STARTED?(self._showMessage("uploading"),self.el.addClass("disabled")):uploader.state===plupload.STOPPED&&self.el.removeClass("disabled")}),uploader.bind("FileUploaded",function(up,file,response){var evalResult=eval(response.response);evalResult&&evalResult.error===!0&&(file.status=plupload.FAILED,self._showMessage("error",evalResult.message)),self.debug("FileUploaded: "+file.name+", response:"+evalResult),file.status==plupload.DONE&&self._showMessage("success")}),uploader.bind("UploadComplete",function(a,b){self.el.removeClass("working")}),uploader.bind("UploadProgress",function(a,b){jQuery("div.messages div.message.uploading span.percent",self.el).html(b.percent+"%")})},_showMessage:function(a,b){jQuery("div.messages div.message",this.el).each(function(){var c=$(this);c.toggle(c.hasClass(a)),b&&c.hasClass(a)&&c.html(b)})},debug:function(a){$("div.debug",this.el).append($("<div></div>").html(a))}}),$.fn.pluploadUI.types.single=SingleFileUIClass,$.fn.pluploadUI.types.single.defaults={uploader:{multi_selection:!1}}}(jQuery),function($){var delay=window.setTimeout,delayPeriod=20,statusesCssHash={};$.each(["done","failed","queued","uploading"],function(a,b){statusesCssHash[plupload[b.toUpperCase()]]=b});var QueueUIClass=function(){this.initialize.apply(this,arguments)};$.extend(QueueUIClass.prototype,{initialize:function(a,b){this.options=b,this.el=this._createUI(a,b),this.filesErrorsOnAdd={},this.uploader=new plupload.Uploader(b.uploader),this._initUploadListeners(),this.uploader.init()},_createUI:function(a,b){var c=$('<div class="pluploadUI queue"><div class="noruntime"/><div id="'+b.container.id+'" class="choose"><div id="'+b.browse.id+'" class="button">'+$.pluploadUI.i18n.t("browseButton.text")+'</div><div class="info"/><div class="clear"/></div><div class="filesList"><div class="header"><div class="name">'+$.pluploadUI.i18n.t("queue.header.name")+'</div><div class="progress">'+$.pluploadUI.i18n.t("queue.header.status")+'</div><div class="size">'+$.pluploadUI.i18n.t("queue.header.size")+'</div><div class="clear"/></div><div class="files"/><div class="footer"><div class="name"><div class="start"><a class="button start" href="javascript:;" style="display: none">'+$.pluploadUI.i18n.t("queue.footer.start")+'</a></div><div class="uploading"><span class="status">'+$.pluploadUI.i18n.t("queue.messages.uploading")+'</span> <a class="button stop" href="javascript:;">'+$.pluploadUI.i18n.t("queue.footer.stop")+'</a></div><div class="complete"><span class="status">'+$.pluploadUI.i18n.t("queue.messages.success")+'</span> <span class="uploaded"/><a class="button clear" href="javascript:;">'+$.pluploadUI.i18n.t("queue.footer.clear")+'</a></div><div class="stopped"><span class="status">'+$.pluploadUI.i18n.t("queue.messages.stopped")+'</span> <span class="uploaded"/><a class="button resume" href="javascript:;">'+$.pluploadUI.i18n.t("queue.footer.resume")+'</a><a class="button clear" href="javascript:;">'+$.pluploadUI.i18n.t("queue.footer.clear")+'</a></div></div><div class="progress">0%</div><div class="size">0 KB</div><div class="clear"/></div></div><div class="debug"><h5>debugging:</h5></div></div>');b.browse.cls&&$("div.choose div.button",c).addClass(b.browse.cls),b.container.cls&&c.addClass(b.container.cls),$("div.info",c).append($("div.info",a).children());var d=this;$("a.button.stop",c).click(function(a){a.preventDefault(),d.uploader.stop(),d.el.addClass("stopped")}),$("a.button.resume, a.button.start",c).click(function(a){a.preventDefault(),d.uploader.start()}),$("a.button.clear",c).click(function(a){a.preventDefault(),d._clearCompleted()});return c.appendTo(a)},_initUploadListeners:function(){var uploader=this.uploader,self=this;uploader.bind("Init",function(a,b){self.debug("Current runtime: "+b.runtime)}),uploader.bind("FilesAdded",function(a,b){delay(function(){$.each(b,function(a,b){$("div.filesList div.files",self.el).append($('<div class="file"/>').attr("id",b.id).append($('<div class="name"/>').html(b.name),$('<div class="progress"/>').html("0%"),$('<div class="size"/>').html(plupload.formatSize(b.size)),$('<div class="clear"/>'),$('<div class="error"/>'))),self.filesErrorsOnAdd[b.id]&&self._handleFileStatus(b,self.filesErrorsOnAdd[b.id].message)}),a.refresh();var c=!1;for(var d=0;d<a.files.length;d++)if(a.files[d].status==plupload.QUEUED){c=!0;break}self._updateTotals(),c&&a.start()},delayPeriod)}),uploader.bind("Error",function(a,b){delay(function(){var c=null;b.code==plupload.INIT_ERROR?(self.el.addClass("noRuntimeAvailable"),$("div.noruntime",self.el).html($.pluploadUI.errorCodeToI18nKey(b.code)?$.pluploadUI.i18n.t($.pluploadUI.errorCodeToI18nKey(b.code)):b.message)):b.code==plupload.FILE_SIZE_ERROR&&(c=$.pluploadUI.i18n.t($.pluploadUI.errorCodeToI18nKey(b.code),{size:plupload.formatSize(b.file.size),max:plupload.formatSize(a.settings.max_file_size)})),c===null&&(c=$.pluploadUI.errorCodeToI18nKey(b.code)?$.pluploadUI.i18n.t($.pluploadUI.errorCodeToI18nKey(b.code)):b.message);var d=b.file;d&&(d.status=plupload.FAILED,self._handleFileStatus(d,c))},delayPeriod)}),uploader.bind("StateChanged",function(){delay(function(){uploader.state===plupload.STARTED?(self.el.addClass("uploading disabled"),self.el.removeClass("uploadComplete stopped start")):uploader.state===plupload.STOPPED&&self.el.removeClass("uploading disabled")},delayPeriod)}),uploader.bind("FileUploaded",function(up,file,response){delay(function(){var evalResult=eval(response.response),errorMessage=null;evalResult&&evalResult.error===!0?(file.status=plupload.FAILED,errorMessage=evalResult.message):file.status==plupload.DONE&&self._updateFileProgress(file),self.debug("FileUploaded: "+file.name+", response:"+evalResult),self._handleFileStatus(file,errorMessage),self._updateTotals()},delayPeriod)}),uploader.bind("UploadComplete",function(a,b){delay(function(){self.el.removeClass("uploading"),self.el.addClass("uploadComplete"),self._updateTotals()},delayPeriod)}),uploader.bind("UploadProgress",function(a,b){delay(function(){self._updateFileProgress(b),self._handleFileStatus(b),self._updateTotals()},delayPeriod)})},_handleFileStatus:function(a,b){var c=$("#"+a.id);if(c.length>0){var d=statusesCssHash[a.status];c.attr("class","file "+d),b&&$("div.error",c).html(b)}else this.filesErrorsOnAdd[a.id]={file:a,message:b}},_updateFileProgress:function(a){var b=$("#"+a.id);$("div.progress",b).html(a.percent+"%")},_updateTotals:function(){$("div.footer div.progress",this.el).html(this.uploader.total.percent+"%"),$("div.footer div.size",this.el).html(plupload.formatSize(this.uploader.total.size)),$("div.footer div.name span.uploaded",this.el).html($.pluploadUI.i18n.t("queue.footer.uploaded",{uploaded:this.uploader.total.uploaded,total:this.uploader.files.length}))},_clearCompleted:function(){var a=this,b=[];$.each(this.uploader.files,function(a,c){(c.status==plupload.DONE||c.status==plupload.FAILED)&&b.push(c)}),$.each(b,function(b,c){var d=$("#"+c.id);a.uploader.removeFile(c),d.remove()}),$("div.files div.file.failed",this.el).remove(),this.el.removeClass("uploadComplete stopped"),this._showStart(),this._updateTotals()},_showStart:function(){this.el.addClass("start");var a=!1;$.each(this.uploader.files,function(b,c){c.status==plupload.QUEUED&&(a=!0)}),$("a.button.start",this.el).toggle(a)},debug:function(a){$("div.debug",this.el).append($("<div></div>").html(a))}}),$.fn.pluploadUI.types.queue=QueueUIClass,$.fn.pluploadUI.types.queue.defaults={uploader:{multi_selection:!0}}}(jQuery)